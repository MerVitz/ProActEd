{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <link rel="stylesheet" href="{% static 'css/profile.css' %}">
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>Student Profile</h2>
            </div>
            <div class="card-body">
                <div class="profile-row">
                    <div class="profile-pic">
                        {% if student.profile_picture %}
                            <img src="{{ student.profile_picture.url }}" alt="Profile Picture">
                        {% else %}
                            <img src="{% static 'images/default_profile_picture.png' %}" alt="Default Profile Picture">
                        {% endif %}
                    </div>
                    <div class="profile-info">
                        <h3>{{ student.get_full_name }}</h3>
                        <p><strong>Email:</strong> {{ student.email }}</p>
                        <p><strong>Phone:</strong> {{ student.userprofile.phone_number }}</p>
                        <hr>
                        <h4>Academic Information</h4>
                        <p><strong>Registration Number:</strong> {{ student.registration_number }}</p>
                        <p><strong>Course:</strong> {{ student.course.name }}</p>
                        <p><strong>School:</strong> {{ student.school.name }}</p>
                        <p><strong>Graduation Probability:</strong> {{ student.graduation_probability }}%</p>
                        <p><strong>Attendance:</strong></p>
                        <ul>
                            {% for attendance in attendance_records %}
                                <li>Semester: {{ attendance.semester }} - Attendance: {{ attendance.attended_classes }}/{{ attendance.total_classes }}</li>
                            {% endfor %}
                        </ul>
                        <p><strong>Performance:</strong></p>
                        <ul>
                            {% for performance in performance_records %}
                                <li>Semester: {{ performance.semester }} - AGP: {{ performance.aggregate_points }}</li>
                            {% endfor %}
                        </ul>
                        <button id="updateProfileBtn">Update Profile</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- The Modal -->
    <div id="updateProfileModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <form id="updateProfileForm" method="post" enctype="multipart/form-data" action="{% url 'profile' %}">
                {% csrf_token %}
                <label for="id_full_name">Full Name:</label>
                <input type="text" id="id_full_name" name="full_name" value="{{ student.user.userprofile.full_name }}">
                
                <label for="id_registration_number">Registration Number:</label>
                <input type="text" id="id_registration_number" name="registration_number" value="{{ student.registration_number }}">
                
                <label for="id_course">Course:</label>
                <select id="id_course" name="course">
                    {% for course in courses %}
                        <option value="{{ course.id }}" {% if course.id == student.course.id %} selected {% endif %}>{{ course.name }}</option>
                    {% endfor %}
                </select>
                
                <label for="id_school">School:</label>
                <select id="id_school" name="school">
                    {% for school in schools %}
                        <option value="{{ school.id }}" {% if school.id == student.school.id %} selected {% endif %}>{{ school.name }}</option>
                    {% endfor %}
                </select>
                
                <label for="id_email">Email:</label>
                <input type="email" id="id_email" name="email" value="{{ student.user.email }}">
                
                <label for="id_phone_number">Phone Number:</label>
                <input type="text" id="id_phone_number" name="phone_number" value="{{ student.user.userprofile.phone_number }}">
                
                <label for="id_parents_phone_number">Parent's Phone Number:</label>
                <input type="text" id="id_parents_phone_number" name="parents_phone_number" value="{{ student.user.userprofile.parents_phone_number }}">
                
                <label for="id_bio">Bio:</label>
                <textarea id="id_bio" name="bio">{{ student.user.userprofile.bio }}</textarea>
                
                <label for="id_profile_picture">Profile Picture:</label>
                <input type="file" id="id_profile_picture" name="profile_picture">
                
                <button type="submit">Update</button>
            </form>
        </div>
    </div>
    <div class="info-div" id="infoDiv">
        Click on a bar to view details.
    </div>
    <canvas id="barChart"></canvas>
    <!-- Including Three.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Get the canvas element and context
        const canvas = document.getElementById('barChart');
        const context = canvas.getContext('webgl');

        // Initialize the Three.js scene
        const scene = new THREE.Scene();

        // Create a camera and add it to the scene
        const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        camera.position.z = 5;
        scene.add(camera);

        // Create a renderer and set its size
        const renderer = new THREE.WebGLRenderer({ canvas: canvas });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);

        // Create a box geometry for the bars
        const boxGeometry = new THREE.BoxGeometry(1, 1, 1);

        // Function to create a bar with height based on input data
        function createBar(x, y, z, height, color, name, value) {
            // Shiny, metallic material
            const material = new THREE.MeshStandardMaterial({
                color: color,
                metalness: 1,
                roughness: 0.2,
            });
            const bar = new THREE.Mesh(boxGeometry, material);
            bar.position.set(x, y + height / 2, z);
            bar.scale.set(1, height, 1);
            bar.name = name;
            bar.userData.value = value; // Store value as user data
            scene.add(bar);

            // Add event listener for click
            bar.onClick = function() {
                document.getElementById('infoDiv').innerHTML = `<strong>${name}</strong><br>Value: ${value}`;
            };

            // Raycaster setup for click detection
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            canvas.addEventListener('click', onMouseClick, false);

            function onMouseClick(event) {
                event.preventDefault();

                mouse.x = (event.offsetX / canvas.clientWidth) * 2 - 1;
                mouse.y = -(event.offsetY / canvas.clientHeight) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);

                const intersects = raycaster.intersectObjects(scene.children);

                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    if (object.onClick) {
                        object.onClick();
                    }
                }
            }

            return bar;
        }

        // Example data (replace with actual student data)
        const data = [
            { name: 'Attendance', value: 80, color: 0x007BFF }, // Blue color
            { name: 'Performance', value: 75, color: 0x28A745 }, // Green color
        ];

        // Create bars based on data
        const bars = [];
        let startX = -data.length;

        data.forEach((item, index) => {
            const bar = createBar(startX + index * 2, 0, -5, item.value / 100 * 5, new THREE.Color(item.color), item.name, item.value); // Adjusted z position to move bars away from the edge
            bars.push(bar);
        });



        // Animation function
        function animate() {
            requestAnimationFrame(animate);

            // Rotate bars
            bars.forEach((bar, index) => {
                bar.rotation.x += 0.00;
                bar.rotation.y += 0.005;
            });

            // Render scene
            renderer.render(scene, camera);
        }

        animate();
    </script>


    <script>
        // Get the modal
        var modal = document.getElementById("updateProfileModal");

        // Get the button that opens the modal
        var btn = document.getElementById("updateProfileBtn");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks the button, open the modal 
        btn.onclick = function() {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>

</body>
</html>
